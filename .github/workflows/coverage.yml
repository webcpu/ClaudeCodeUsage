name: Code Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Swift
      uses: swift-actions/setup-swift@v1
      with:
        swift-version: '5.9'
        
    - name: Build with coverage
      run: swift build --enable-code-coverage
      
    - name: Run tests with coverage
      run: swift test --enable-code-coverage --parallel
      
    - name: Generate coverage report
      run: |
        COVERAGE_DIR=$(swift test --show-codecov-path | head -1 | sed 's/.*: //')
        BINARY_PATH=".build/debug/ClaudeCodeUsagePackageTests.xctest/Contents/MacOS/ClaudeCodeUsagePackageTests"
        
        # Generate LCOV report
        xcrun llvm-cov export \
          -format="lcov" \
          -instr-profile="$COVERAGE_DIR" \
          "$BINARY_PATH" \
          > coverage.lcov
        
        # Generate summary
        xcrun llvm-cov report \
          -instr-profile="$COVERAGE_DIR" \
          "$BINARY_PATH" \
          -ignore-filename-regex=".*Tests.*|.*Mocks.*"
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.lcov
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        
    - name: Generate coverage badge
      run: |
        COVERAGE=$(xcrun llvm-cov report \
          -instr-profile="$(swift test --show-codecov-path | head -1 | sed 's/.*: //')" \
          ".build/debug/ClaudeCodeUsagePackageTests.xctest/Contents/MacOS/ClaudeCodeUsagePackageTests" \
          -ignore-filename-regex=".*Tests.*|.*Mocks.*" 2>/dev/null | \
          tail -1 | \
          awk '{print $NF}' | \
          sed 's/%//')
        
        echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
        
    - name: Create coverage badge
      uses: schneegans/dynamic-badges-action@v1.6.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: YOUR_GIST_ID_HERE
        filename: coverage.json
        label: Coverage
        message: ${{ env.COVERAGE }}%
        color: ${{ env.COVERAGE >= 80 && 'green' || env.COVERAGE >= 60 && 'yellow' || 'red' }}
        
    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = process.env.COVERAGE;
          const threshold = 80;
          const emoji = coverage >= threshold ? '✅' : '⚠️';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ${emoji} Code Coverage Report\n\n**Coverage: ${coverage}%** (Threshold: ${threshold}%)\n\n[View detailed report](https://codecov.io/gh/${context.repo.owner}/${context.repo.repo})`
          })
    
    - name: Check coverage threshold
      run: |
        THRESHOLD=80
        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "::warning::Code coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
          exit 1
        fi